/**
 *
 * Copyright 2024-2025 David Herron
 *
 * This file is part of AkashaCMS (http://akashacms.com/).
 *
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 */
/**
 * SQL Database support using SQLITE3.
 *
 * What's supported is SQLITE3ORM - a lightweight
 * ORM that runs on top of SQLITE3.
 */
import fs from 'node:fs';
import { Base64 } from 'js-base64';
// import sqleanLibs from 'sqlite3-sqlean';
import * as sqlite_regex from "sqlite-regex";
import { SQ3DataStore } from 'sq3-kv-data-store';
import { AsyncDatabase } from 'promised-sqlite3';
import { init } from './data-new.js';
/**
 * Subclass the SqlDatabase so we can expose
 * the underlying SQLITE3 Database object and
 * some useful methods on that class.
 */
// export class SqlDatabaseChild extends SqlDatabase {
//     get _db(): Database { return this.db; }
//     loadExtension(filename: string, callback?: (err?: Error | null) => void): Database {
//         return this.db.loadExtension(filename, callback);
//     }
// }
const dburl = typeof process.env.AK_DB_URL === 'string'
    ? process.env.AK_DB_URL
    : ':memory:';
// Turns on full stack traces
// SqlDatabase.verbose();
export const sqdb = await AsyncDatabase.open(dburl);
// await sqdb.open(dburl);
// await sqdb.open('test.db');
// sqdb.loadExtension(sqleanLibs.reLibPath);
sqdb.inner.loadExtension(sqlite_regex.getLoadablePath());
await init();
// This traces SQL statements
//
// sqdb.inner.on('trace', sql => {
//     console.log(sql);
// });
sqdb.inner.on('error', err => {
    console.error(err);
});
sqdb.inner.on('error', err => {
    console.error(err);
});
// Profiling SQL queries
// This might be useful for performance evaluation.
// The output is TSV separated fields:
//   1. base64-encoded SQL
//      This was chosen to prevent newlines in this field
//      and to keep the format simple
//   2. Approximate number of milliseconds to execute
//
// In practice the number of milliseconds is either
// zero or one, indicating there isn't enough precision
// in the code invoking this callback.
//
// In other words this doesn't seem terribly useful.
if (typeof process.env.AK_PROFILE === 'string') {
    sqdb.inner.on('profile', (sql, time) => {
        fs.writeFileSync(process.env.AK_PROFILE, `${Base64.encode(sql)}\t${time}\n`, { flag: "a+" });
    });
}
////////////////////////
export function newSQ3DataStore(name) {
    // console.log(`newSQ3DataStore ${name}`);
    return new SQ3DataStore(sqdb.inner, name);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3FkYi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL2xpYi9zcWRiLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7Ozs7OztHQWlCRztBQUVIOzs7OztHQUtHO0FBRUgsT0FBTyxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQ3pCLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFFbkMsMkNBQTJDO0FBQzNDLE9BQU8sS0FBSyxZQUFZLE1BQU0sY0FBYyxDQUFDO0FBRzdDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUVqRCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDakQsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUVyQzs7OztHQUlHO0FBQ0gsc0RBQXNEO0FBQ3RELDhDQUE4QztBQUU5QywyRkFBMkY7QUFDM0YsNERBQTREO0FBQzVELFFBQVE7QUFDUixJQUFJO0FBRUosTUFBTSxLQUFLLEdBQUcsT0FBTyxPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsS0FBSyxRQUFRO0lBQy9DLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVM7SUFDdkIsQ0FBQyxDQUFDLFVBQVUsQ0FBQztBQUVyQiw2QkFBNkI7QUFDN0IseUJBQXlCO0FBQ3pCLE1BQU0sQ0FBQyxNQUFNLElBQUksR0FBRyxNQUFNLGFBQWEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDcEQsMEJBQTBCO0FBQzFCLDhCQUE4QjtBQUM5Qiw0Q0FBNEM7QUFDNUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhLENBQUMsWUFBWSxDQUFDLGVBQWUsRUFBRSxDQUFDLENBQUM7QUFFekQsTUFBTSxJQUFJLEVBQUUsQ0FBQztBQUViLDZCQUE2QjtBQUM3QixFQUFFO0FBQ0Ysa0NBQWtDO0FBQ2xDLHdCQUF3QjtBQUN4QixNQUFNO0FBQ04sSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxFQUFFO0lBQ3pCLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDdkIsQ0FBQyxDQUFDLENBQUM7QUFFSCxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxPQUFPLEVBQUUsR0FBRyxDQUFDLEVBQUU7SUFDekIsT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUN2QixDQUFDLENBQUMsQ0FBQztBQUVILHdCQUF3QjtBQUN4QixtREFBbUQ7QUFDbkQsc0NBQXNDO0FBQ3RDLDBCQUEwQjtBQUMxQix5REFBeUQ7QUFDekQscUNBQXFDO0FBQ3JDLHFEQUFxRDtBQUNyRCxFQUFFO0FBQ0YsbURBQW1EO0FBQ25ELHVEQUF1RDtBQUN2RCxzQ0FBc0M7QUFDdEMsRUFBRTtBQUNGLG9EQUFvRDtBQUNwRCxJQUFJLE9BQU8sT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLEtBQUssUUFBUSxFQUFFLENBQUM7SUFDN0MsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsU0FBUyxFQUFFLENBQUMsR0FBRyxFQUFFLElBQUksRUFBRSxFQUFFO1FBQ25DLEVBQUUsQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLEVBQ25DLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsS0FBSyxJQUFJLElBQUksRUFDbEMsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLENBQ2pCLENBQUM7SUFDTixDQUFDLENBQUMsQ0FBQztBQUNQLENBQUM7QUFFRCx3QkFBd0I7QUFFeEIsTUFBTSxVQUFVLGVBQWUsQ0FBQyxJQUFZO0lBR3hDLDBDQUEwQztJQUMxQyxPQUFPLElBQUksWUFBWSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFDOUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICpcbiAqIENvcHlyaWdodCAyMDI0LTIwMjUgRGF2aWQgSGVycm9uXG4gKlxuICogVGhpcyBmaWxlIGlzIHBhcnQgb2YgQWthc2hhQ01TIChodHRwOi8vYWthc2hhY21zLmNvbS8pLlxuICpcbiAqICBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqICBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqICBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiAgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG4vKipcbiAqIFNRTCBEYXRhYmFzZSBzdXBwb3J0IHVzaW5nIFNRTElURTMuXG4gKiBcbiAqIFdoYXQncyBzdXBwb3J0ZWQgaXMgU1FMSVRFM09STSAtIGEgbGlnaHR3ZWlnaHRcbiAqIE9STSB0aGF0IHJ1bnMgb24gdG9wIG9mIFNRTElURTMuXG4gKi9cblxuaW1wb3J0IGZzIGZyb20gJ25vZGU6ZnMnO1xuaW1wb3J0IHsgQmFzZTY0IH0gZnJvbSAnanMtYmFzZTY0JztcbmltcG9ydCB7IERhdGFiYXNlIH0gZnJvbSAnc3FsaXRlMyc7XG4vLyBpbXBvcnQgc3FsZWFuTGlicyBmcm9tICdzcWxpdGUzLXNxbGVhbic7XG5pbXBvcnQgKiBhcyBzcWxpdGVfcmVnZXggZnJvbSBcInNxbGl0ZS1yZWdleFwiO1xuXG5pbXBvcnQgeyBTcWxEYXRhYmFzZSB9IGZyb20gJ3NxbGl0ZTNvcm0nO1xuaW1wb3J0IHsgU1EzRGF0YVN0b3JlIH0gZnJvbSAnc3EzLWt2LWRhdGEtc3RvcmUnO1xuXG5pbXBvcnQgeyBBc3luY0RhdGFiYXNlIH0gZnJvbSAncHJvbWlzZWQtc3FsaXRlMyc7XG5pbXBvcnQgeyBpbml0IH0gZnJvbSAnLi9kYXRhLW5ldy5qcyc7XG5cbi8qKlxuICogU3ViY2xhc3MgdGhlIFNxbERhdGFiYXNlIHNvIHdlIGNhbiBleHBvc2VcbiAqIHRoZSB1bmRlcmx5aW5nIFNRTElURTMgRGF0YWJhc2Ugb2JqZWN0IGFuZFxuICogc29tZSB1c2VmdWwgbWV0aG9kcyBvbiB0aGF0IGNsYXNzLlxuICovXG4vLyBleHBvcnQgY2xhc3MgU3FsRGF0YWJhc2VDaGlsZCBleHRlbmRzIFNxbERhdGFiYXNlIHtcbi8vICAgICBnZXQgX2RiKCk6IERhdGFiYXNlIHsgcmV0dXJuIHRoaXMuZGI7IH1cblxuLy8gICAgIGxvYWRFeHRlbnNpb24oZmlsZW5hbWU6IHN0cmluZywgY2FsbGJhY2s/OiAoZXJyPzogRXJyb3IgfCBudWxsKSA9PiB2b2lkKTogRGF0YWJhc2Uge1xuLy8gICAgICAgICByZXR1cm4gdGhpcy5kYi5sb2FkRXh0ZW5zaW9uKGZpbGVuYW1lLCBjYWxsYmFjayk7XG4vLyAgICAgfVxuLy8gfVxuXG5jb25zdCBkYnVybCA9IHR5cGVvZiBwcm9jZXNzLmVudi5BS19EQl9VUkwgPT09ICdzdHJpbmcnXG4gICAgICAgID8gcHJvY2Vzcy5lbnYuQUtfREJfVVJMXG4gICAgICAgIDogJzptZW1vcnk6JztcblxuLy8gVHVybnMgb24gZnVsbCBzdGFjayB0cmFjZXNcbi8vIFNxbERhdGFiYXNlLnZlcmJvc2UoKTtcbmV4cG9ydCBjb25zdCBzcWRiID0gYXdhaXQgQXN5bmNEYXRhYmFzZS5vcGVuKGRidXJsKTtcbi8vIGF3YWl0IHNxZGIub3BlbihkYnVybCk7XG4vLyBhd2FpdCBzcWRiLm9wZW4oJ3Rlc3QuZGInKTtcbi8vIHNxZGIubG9hZEV4dGVuc2lvbihzcWxlYW5MaWJzLnJlTGliUGF0aCk7XG5zcWRiLmlubmVyLmxvYWRFeHRlbnNpb24oc3FsaXRlX3JlZ2V4LmdldExvYWRhYmxlUGF0aCgpKTtcblxuYXdhaXQgaW5pdCgpO1xuXG4vLyBUaGlzIHRyYWNlcyBTUUwgc3RhdGVtZW50c1xuLy9cbi8vIHNxZGIuaW5uZXIub24oJ3RyYWNlJywgc3FsID0+IHtcbi8vICAgICBjb25zb2xlLmxvZyhzcWwpO1xuLy8gfSk7XG5zcWRiLmlubmVyLm9uKCdlcnJvcicsIGVyciA9PiB7XG4gICAgY29uc29sZS5lcnJvcihlcnIpO1xufSk7XG5cbnNxZGIuaW5uZXIub24oJ2Vycm9yJywgZXJyID0+IHtcbiAgICBjb25zb2xlLmVycm9yKGVycik7XG59KTtcblxuLy8gUHJvZmlsaW5nIFNRTCBxdWVyaWVzXG4vLyBUaGlzIG1pZ2h0IGJlIHVzZWZ1bCBmb3IgcGVyZm9ybWFuY2UgZXZhbHVhdGlvbi5cbi8vIFRoZSBvdXRwdXQgaXMgVFNWIHNlcGFyYXRlZCBmaWVsZHM6XG4vLyAgIDEuIGJhc2U2NC1lbmNvZGVkIFNRTFxuLy8gICAgICBUaGlzIHdhcyBjaG9zZW4gdG8gcHJldmVudCBuZXdsaW5lcyBpbiB0aGlzIGZpZWxkXG4vLyAgICAgIGFuZCB0byBrZWVwIHRoZSBmb3JtYXQgc2ltcGxlXG4vLyAgIDIuIEFwcHJveGltYXRlIG51bWJlciBvZiBtaWxsaXNlY29uZHMgdG8gZXhlY3V0ZVxuLy9cbi8vIEluIHByYWN0aWNlIHRoZSBudW1iZXIgb2YgbWlsbGlzZWNvbmRzIGlzIGVpdGhlclxuLy8gemVybyBvciBvbmUsIGluZGljYXRpbmcgdGhlcmUgaXNuJ3QgZW5vdWdoIHByZWNpc2lvblxuLy8gaW4gdGhlIGNvZGUgaW52b2tpbmcgdGhpcyBjYWxsYmFjay5cbi8vXG4vLyBJbiBvdGhlciB3b3JkcyB0aGlzIGRvZXNuJ3Qgc2VlbSB0ZXJyaWJseSB1c2VmdWwuXG5pZiAodHlwZW9mIHByb2Nlc3MuZW52LkFLX1BST0ZJTEUgPT09ICdzdHJpbmcnKSB7XG4gICAgc3FkYi5pbm5lci5vbigncHJvZmlsZScsIChzcWwsIHRpbWUpID0+IHtcbiAgICAgICAgZnMud3JpdGVGaWxlU3luYyhwcm9jZXNzLmVudi5BS19QUk9GSUxFLFxuICAgICAgICAgICAgYCR7QmFzZTY0LmVuY29kZShzcWwpfVxcdCR7dGltZX1cXG5gLFxuICAgICAgICAgICAgeyBmbGFnOiBcImErXCIgfVxuICAgICAgICApO1xuICAgIH0pO1xufVxuXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuZXhwb3J0IGZ1bmN0aW9uIG5ld1NRM0RhdGFTdG9yZShuYW1lOiBzdHJpbmcpXG4gICAgOiBTUTNEYXRhU3RvcmVcbntcbiAgICAvLyBjb25zb2xlLmxvZyhgbmV3U1EzRGF0YVN0b3JlICR7bmFtZX1gKTtcbiAgICByZXR1cm4gbmV3IFNRM0RhdGFTdG9yZShzcWRiLmlubmVyLCBuYW1lKTtcbn1cbiJdfQ==