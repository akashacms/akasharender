/**
 *
 * Copyright 2014-2024 David Herron
 *
 * This file is part of AkashaCMS (http://akashacms.com/).
 *
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 */
import path from 'node:path';
import { promises as fsp } from 'node:fs';
import { sqdb } from './sqdb.js';
const sql_create_table = await fsp.readFile(path.join(import.meta.dirname, 'sql', 'data-create-table.sql'), 'utf-8');
const sql_add_report = await fsp.readFile(path.join(import.meta.dirname, 'sql', 'data-add-report.sql'), 'utf-8');
const sql_delete_traces = await fsp.readFile(path.join(import.meta.dirname, 'sql', 'data-delete-traces.sql'), 'utf-8');
const sql_delete_all_traces = await fsp.readFile(path.join(import.meta.dirname, 'sql', 'data-delete-all-traces.sql'), 'utf-8');
const sql_get_all_traces = await fsp.readFile(path.join(import.meta.dirname, 'sql', 'data-get-all-traces.sql'), 'utf-8');
const sql_get_for_file = await fsp.readFile(path.join(import.meta.dirname, 'sql', 'data-for-file.sql'), 'utf-8');
class Trace {
}
export async function init() {
    await (await sqdb).run(sql_create_table);
}
export async function report(basedir, fpath, renderTo, stage, start) {
    const trace = new Trace();
    trace.basedir = basedir;
    trace.fpath = fpath;
    trace.fullpath = path.join(basedir, fpath);
    trace.renderTo = renderTo;
    trace.stage = stage;
    trace.start = start.toISOString();
    trace.now = new Date().toISOString();
    // console.log(`data report`, trace);
    await (await sqdb).run(await sql_add_report, {
        $basedir: trace.basedir,
        $fpath: trace.fpath,
        $fullpath: trace.fullpath,
        $renderTo: trace.renderTo,
        $stage: trace.stage,
        $start: trace.start,
        $now: trace.now
    });
}
;
/**
 * Support removing items from the saved data.  This is useful
 * when we're rendering the same file multiple times.
 *
 * @param {*} basedir
 * @param {*} fpath
 */
export async function remove(basedir, fpath) {
    try {
        await (await sqdb).run(await sql_delete_traces, {
            $basedir: basedir,
            $fpath: fpath
        });
    }
    catch (err) { }
}
;
export async function removeAll() {
    try {
        await (await sqdb).run(await sql_delete_all_traces);
    }
    catch (err) { }
}
;
export async function print() {
    const traces = await (await sqdb).all(await sql_get_all_traces);
    for (let trace of traces) {
        console.log(`${trace.fullpath} ${trace.renderTo} ${trace.stage} ${(new Date(trace.now).valueOf() - new Date(trace.start).valueOf()) / 1000} seconds`);
    }
}
;
export async function data4file(basedir, fpath) {
    // console.log(`data4file ${basedir} ${fpath}`);
    let ret = "";
    const traces = await (await sqdb).all(await sql_get_for_file, {
        $basedir: basedir,
        $fpath: fpath
    });
    for (let trace of traces) {
        if (trace.basedir === basedir && trace.fpath === fpath) {
            ret += `${trace.fullpath} ${trace.renderTo} ${trace.stage} ${(new Date(trace.now).valueOf() - new Date(trace.start).valueOf()) / 1000} seconds\n`;
        }
    }
    return ret;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YS1uZXcuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9saWIvZGF0YS1uZXcudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBaUJHO0FBRUgsT0FBTyxJQUFJLE1BQU0sV0FBVyxDQUFDO0FBQzdCLE9BQU8sRUFBRSxRQUFRLElBQUksR0FBRyxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBRTFDLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFHakMsTUFBTSxnQkFBZ0IsR0FBRyxNQUFNLEdBQUcsQ0FBQyxRQUFRLENBQ3ZDLElBQUksQ0FBQyxJQUFJLENBQ0wsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsS0FBSyxFQUFFLHVCQUF1QixDQUN0RCxFQUNELE9BQU8sQ0FDVixDQUFDO0FBRUYsTUFBTSxjQUFjLEdBQUcsTUFBTSxHQUFHLENBQUMsUUFBUSxDQUNyQyxJQUFJLENBQUMsSUFBSSxDQUNMLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLEtBQUssRUFBRSxxQkFBcUIsQ0FDcEQsRUFDRCxPQUFPLENBQ1YsQ0FBQztBQUVGLE1BQU0saUJBQWlCLEdBQUcsTUFBTSxHQUFHLENBQUMsUUFBUSxDQUN4QyxJQUFJLENBQUMsSUFBSSxDQUNMLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLEtBQUssRUFBRSx3QkFBd0IsQ0FDdkQsRUFDRCxPQUFPLENBQ1YsQ0FBQztBQUVGLE1BQU0scUJBQXFCLEdBQUcsTUFBTSxHQUFHLENBQUMsUUFBUSxDQUM1QyxJQUFJLENBQUMsSUFBSSxDQUNMLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLEtBQUssRUFBRSw0QkFBNEIsQ0FDM0QsRUFDRCxPQUFPLENBQ1YsQ0FBQztBQUVGLE1BQU0sa0JBQWtCLEdBQUcsTUFBTSxHQUFHLENBQUMsUUFBUSxDQUN6QyxJQUFJLENBQUMsSUFBSSxDQUNMLE1BQU0sQ0FBQyxJQUFJ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SSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE9BQU8sRUFBRSxHQUFHLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxHQUFHLElBQUksVUFBVSxDQUFDLENBQUE7SUFDekosQ0FBQztBQUNMLENBQUM7QUFBQSxDQUFDO0FBRUYsTUFBTSxDQUFDLEtBQUssVUFBVSxTQUFTLENBQUMsT0FBTyxFQUFFLEtBQUs7SUFDMUMsZ0RBQWdEO0lBQ2hELElBQUksR0FBRyxHQUFHLEVBQUUsQ0FBQztJQUViLE1BQU0sTUFBTSxHQUNOLE1BQU0sQ0FBQyxNQUFNLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBUSxNQUFNLGdCQUFnQixFQUFFO1FBQ3hELFFBQVEsRUFBRSxPQUFPO1FBQ2pCLE1BQU0sRUFBSSxLQUFLO0tBQ2xCLENBQUMsQ0FBQztJQUVILEtBQUssSUFBSSxLQUFLLElBQUksTUFBTSxFQUFFLENBQUM7UUFDdkIsSUFBSSxLQUFLLENBQUMsT0FBTyxLQUFLLE9BQU8sSUFBSSxLQUFLLENBQUMsS0FBSyxLQUFLLEtBQUssRUFBRSxDQUFDO1lBQ3JELEdBQUcsSUFBSSxHQUFHLEtBQUssQ0FBQyxRQUFRLElBQUksS0FBSyxDQUFDLFFBQVEsSUFBSSxLQUFLLENBQUMsS0FBSyxJQUFJLENBQUMsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE9BQU8sRUFBRSxHQUFHLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxHQUFHLElBQUksWUFBWSxDQUFDO1FBQ3RKLENBQUM7SUFDTCxDQUFDO0lBQ0QsT0FBTyxHQUFHLENBQUM7QUFDZixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKlxuICogQ29weXJpZ2h0IDIwMTQtMjAyNCBEYXZpZCBIZXJyb25cbiAqXG4gKiBUaGlzIGZpbGUgaXMgcGFydCBvZiBBa2FzaGFDTVMgKGh0dHA6Ly9ha2FzaGFjbXMuY29tLykuXG4gKlxuICogIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiAgeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqICBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiAgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiAgU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCBwYXRoIGZyb20gJ25vZGU6cGF0aCc7XG5pbXBvcnQgeyBwcm9taXNlcyBhcyBmc3AgfSBmcm9tICdub2RlOmZzJztcblxuaW1wb3J0IHsgc3FkYiB9IGZyb20gJy4vc3FkYi5qcyc7XG5pbXBvcnQgeyBBc3luY0RhdGFiYXNlIH0gZnJvbSAncHJvbWlzZWQtc3FsaXRlMyc7XG5cbmNvbnN0IHNxbF9jcmVhdGVfdGFibGUgPSBhd2FpdCBmc3AucmVhZEZpbGUoXG4gICAgcGF0aC5qb2luKFxuICAgICAgICBpbXBvcnQubWV0YS5kaXJuYW1lLCAnc3FsJywgJ2RhdGEtY3JlYXRlLXRhYmxlLnNxbCdcbiAgICApLFxuICAgICd1dGYtOCdcbik7XG5cbmNvbnN0IHNxbF9hZGRfcmVwb3J0ID0gYXdhaXQgZnNwLnJlYWRGaWxlKFxuICAgIHBhdGguam9pbihcbiAgICAgICAgaW1wb3J0Lm1ldGEuZGlybmFtZSwgJ3NxbCcsICdkYXRhLWFkZC1yZXBvcnQuc3FsJ1xuICAgICksXG4gICAgJ3V0Zi04J1xuKTtcblxuY29uc3Qgc3FsX2RlbGV0ZV90cmFjZXMgPSBhd2FpdCBmc3AucmVhZEZpbGUoXG4gICAgcGF0aC5qb2luKFxuICAgICAgICBpbXBvcnQubWV0YS5kaXJuYW1lLCAnc3FsJywgJ2RhdGEtZGVsZXRlLXRyYWNlcy5zcWwnXG4gICAgKSxcbiAgICAndXRmLTgnXG4pO1xuXG5jb25zdCBzcWxfZGVsZXRlX2FsbF90cmFjZXMgPSBhd2FpdCBmc3AucmVhZEZpbGUoXG4gICAgcGF0aC5qb2luKFxuICAgICAgICBpbXBvcnQubWV0YS5kaXJuYW1lLCAnc3FsJywgJ2RhdGEtZGVsZXRlLWFsbC10cmFjZXMuc3FsJ1xuICAgICksXG4gICAgJ3V0Zi04J1xuKTtcblxuY29uc3Qgc3FsX2dldF9hbGxfdHJhY2VzID0gYXdhaXQgZnNwLnJlYWRGaWxlKFxuICAgIHBhdGguam9pbihcbiAgICAgICAgaW1wb3J0Lm1ldGEuZGlybmFtZSwgJ3NxbCcsICdkYXRhLWdldC1hbGwtdHJhY2VzLnNxbCdcbiAgICApLFxuICAgICd1dGYtOCdcbik7XG5cbmNvbnN0IHNxbF9nZXRfZm9yX2ZpbGUgPSBhd2FpdCBmc3AucmVhZEZpbGUoXG4gICAgcGF0aC5qb2luKFxuICAgICAgICBpbXBvcnQubWV0YS5kaXJuYW1lLCAnc3FsJywgJ2RhdGEtZm9yLWZpbGUuc3FsJ1xuICAgICksXG4gICAgJ3V0Zi04J1xuKTtcblxuY2xhc3MgVHJhY2Uge1xuICAgIGJhc2VkaXI6IHN0cmluZztcbiAgICBmcGF0aDogc3RyaW5nO1xuICAgIGZ1bGxwYXRoPzogc3RyaW5nO1xuICAgIHJlbmRlclRvOiBzdHJpbmc7XG4gICAgc3RhZ2U6IHN0cmluZztcbiAgICBzdGFydDogc3RyaW5nO1xuICAgIG5vdzogc3RyaW5nO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gaW5pdCgpIHtcbiAgICBhd2FpdCAoYXdhaXQgc3FkYikucnVuKHNxbF9jcmVhdGVfdGFibGUpO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcmVwb3J0KFxuICAgIGJhc2VkaXIsIGZwYXRoLCByZW5kZXJUbywgc3RhZ2UsIHN0YXJ0OiBEYXRlXG4pIHtcbiAgICBjb25zdCB0cmFjZSAgICA9IG5ldyBUcmFjZSgpO1xuICAgIHRyYWNlLmJhc2VkaXIgID0gYmFzZWRpcjtcbiAgICB0cmFjZS5mcGF0aCAgICA9IGZwYXRoO1xuICAgIHRyYWNlLmZ1bGxwYXRoID0gcGF0aC5qb2luKGJhc2VkaXIsIGZwYXRoKTtcbiAgICB0cmFjZS5yZW5kZXJUbyA9IHJlbmRlclRvO1xuICAgIHRyYWNlLnN0YWdlICAgID0gc3RhZ2U7XG4gICAgdHJhY2Uuc3RhcnQgICAgPSBzdGFydC50b0lTT1N0cmluZygpO1xuICAgIHRyYWNlLm5vdyAgICAgID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpO1xuICAgIC8vIGNvbnNvbGUubG9nKGBkYXRhIHJlcG9ydGAsIHRyYWNlKTtcbiAgICBhd2FpdCAoYXdhaXQgc3FkYikucnVuKGF3YWl0IHNxbF9hZGRfcmVwb3J0LCB7XG4gICAgICAgICRiYXNlZGlyOiAgdHJhY2UuYmFzZWRpcixcbiAgICAgICAgJGZwYXRoOiAgICB0cmFjZS5mcGF0aCxcbiAgICAgICAgJGZ1bGxwYXRoOiB0cmFjZS5mdWxscGF0aCxcbiAgICAgICAgJHJlbmRlclRvOiB0cmFjZS5yZW5kZXJUbyxcbiAgICAgICAgJHN0YWdlOiAgICB0cmFjZS5zdGFnZSxcbiAgICAgICAgJHN0YXJ0OiAgICB0cmFjZS5zdGFydCxcbiAgICAgICAgJG5vdzogICAgICAgdHJhY2Uubm93XG4gICAgfSk7XG59O1xuXG4vKipcbiAqIFN1cHBvcnQgcmVtb3ZpbmcgaXRlbXMgZnJvbSB0aGUgc2F2ZWQgZGF0YS4gIFRoaXMgaXMgdXNlZnVsXG4gKiB3aGVuIHdlJ3JlIHJlbmRlcmluZyB0aGUgc2FtZSBmaWxlIG11bHRpcGxlIHRpbWVzLlxuICpcbiAqIEBwYXJhbSB7Kn0gYmFzZWRpclxuICogQHBhcmFtIHsqfSBmcGF0aFxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcmVtb3ZlKGJhc2VkaXIsIGZwYXRoKSB7XG4gICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgKGF3YWl0IHNxZGIpLnJ1bihhd2FpdCBzcWxfZGVsZXRlX3RyYWNlcywge1xuICAgICAgICAgICAgJGJhc2VkaXI6IGJhc2VkaXIsXG4gICAgICAgICAgICAkZnBhdGg6ICAgZnBhdGhcbiAgICAgICAgfSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7fVxufTtcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHJlbW92ZUFsbCgpIHtcbiAgICB0cnkge1xuICAgICAgICBhd2FpdCAoYXdhaXQgc3FkYikucnVuKGF3YWl0IHNxbF9kZWxldGVfYWxsX3RyYWNlcyk7XG4gICAgfSBjYXRjaCAoZXJyKSB7fVxufTtcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHByaW50KCkge1xuICAgIGNvbnN0IHRyYWNlc1xuICAgICAgICA9IGF3YWl0IChhd2FpdCBzcWRiKS5hbGw8VHJhY2U+KGF3YWl0IHNxbF9nZXRfYWxsX3RyYWNlcyk7XG5cbiAgICBmb3IgKGxldCB0cmFjZSBvZiB0cmFjZXMpIHtcbiAgICAgICAgY29uc29sZS5sb2coYCR7dHJhY2UuZnVsbHBhdGh9ICR7dHJhY2UucmVuZGVyVG99ICR7dHJhY2Uuc3RhZ2V9ICR7KG5ldyBEYXRlKHRyYWNlLm5vdykudmFsdWVPZigpIC0gbmV3IERhdGUodHJhY2Uuc3RhcnQpLnZhbHVlT2YoKSkgLyAxMDAwfSBzZWNvbmRzYClcbiAgICB9XG59O1xuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZGF0YTRmaWxlKGJhc2VkaXIsIGZwYXRoKSB7XG4gICAgLy8gY29uc29sZS5sb2coYGRhdGE0ZmlsZSAke2Jhc2VkaXJ9ICR7ZnBhdGh9YCk7XG4gICAgbGV0IHJldCA9IFwiXCI7XG5cbiAgICBjb25zdCB0cmFjZXNcbiAgICAgICAgPSBhd2FpdCAoYXdhaXQgc3FkYikuYWxsPFRyYWNlPihhd2FpdCBzcWxfZ2V0X2Zvcl9maWxlLCB7XG4gICAgICAgICRiYXNlZGlyOiBiYXNlZGlyLFxuICAgICAgICAkZnBhdGg6ICAgZnBhdGhcbiAgICB9KTtcblxuICAgIGZvciAobGV0IHRyYWNlIG9mIHRyYWNlcykge1xuICAgICAgICBpZiAodHJhY2UuYmFzZWRpciA9PT0gYmFzZWRpciAmJiB0cmFjZS5mcGF0aCA9PT0gZnBhdGgpIHtcbiAgICAgICAgICAgIHJldCArPSBgJHt0cmFjZS5mdWxscGF0aH0gJHt0cmFjZS5yZW5kZXJUb30gJHt0cmFjZS5zdGFnZX0gJHsobmV3IERhdGUodHJhY2Uubm93KS52YWx1ZU9mKCkgLSBuZXcgRGF0ZSh0cmFjZS5zdGFydCkudmFsdWVPZigpKSAvIDEwMDB9IHNlY29uZHNcXG5gO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXQ7XG59XG4iXX0=