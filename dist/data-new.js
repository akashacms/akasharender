/**
 *
 * Copyright 2014-2024 David Herron
 *
 * This file is part of AkashaCMS (http://akashacms.com/).
 *
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 */
import path from 'node:path';
import { sqdb } from './sqdb.js';
class Trace {
}
await (await sqdb).run(`
CREATE TABLE IF NOT EXISTS "TRACES" (
    basedir  TEXT,
    fpath    TEXT,
    fullpath TEXt,
    renderTo TEXT,
    stage    TEXT DEFAULT(datetime('now') || 'Z'),
    start    TEXT DEFAULT(datetime('now') || 'Z'),
    now      TEXT DEFAULT(datetime('now') || 'Z')
) WITHOUT ROWID;
CREATE INDEX "traces_basedir" ON "TRACES" ("basedir");
CREATE INDEX "traces_fpath"   ON "TRACES" ("fpath");
`);
export async function report(basedir, fpath, renderTo, stage, start) {
    const trace = new Trace();
    trace.basedir = basedir;
    trace.fpath = fpath;
    trace.fullpath = path.join(basedir, fpath);
    trace.renderTo = renderTo;
    trace.stage = stage;
    trace.start = start;
    trace.now = new Date().toISOString();
    await (await sqdb).run(`
    INSERT INTO "TRACES"
        (
            basedir,
            fpath,
            fullpath,
            renderTo,
            stage,
            start,
            now
        )
        VALUES
        (
            $basedir,
            $fpath,
            $fullpath,
            $renderTo,
            $stage,
            $start,
            $now
        )
    `, {
        $basedir: trace.basedir,
        $fpath: trace.fpath,
        $fullpath: path.join(basedir, fpath),
        $renderTo: trace.renderTo,
        $stage: trace.stage,
        $start: trace.start,
        now: new Date().toISOString()
    });
}
;
/**
 * Support removing items from the saved data.  This is useful
 * when we're rendering the same file multiple times.
 *
 * @param {*} basedir
 * @param {*} fpath
 */
export async function remove(basedir, fpath) {
    try {
        await (await sqdb).run(`
            DELETE FROM "TRACES"
            WHERE
            basedir = $basedir AND fpath = $fpath
        `, {
            $basedir: basedir,
            $fpath: fpath
        });
    }
    catch (err) { }
}
;
export async function removeAll() {
    try {
        await (await sqdb).run(`
            DELETE FROM "TRACES"
        `);
    }
    catch (err) { }
}
;
export async function print() {
    const traces = await (await sqdb).all(`
        SELECT * FROM "TRACES"
        ORDER BY fullpath
    `);
    for (let trace of traces) {
        console.log(`${trace.fullpath} ${trace.renderTo} ${trace.stage} ${(new Date(trace.now).valueOf() - new Date(trace.start).valueOf()) / 1000} seconds`);
    }
}
;
export async function data4file(basedir, fpath) {
    let ret = "";
    const traces = await (await sqdb).all(`
        SELECT * FROM "TRACES"
        WHERE 
            basedir = $basedir AND fpath = $fpath
        ORDER BY fullpath
    `, {
        $basedir: basedir,
        $fpath: fpath
    });
    for (let trace of traces) {
        if (trace.basedir === basedir && trace.fpath === fpath) {
            ret += `${trace.fullpath} ${trace.renderTo} ${trace.stage} ${(new Date(trace.now).valueOf() - new Date(trace.start).valueOf()) / 1000} seconds\n`;
        }
    }
    return ret;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YS1uZXcuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9saWIvZGF0YS1uZXcudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBaUJHO0FBRUgsT0FBTyxJQUFJLE1BQU0sV0FBVyxDQUFDO0FBRTdCLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFFakMsTUFBTSxLQUFLO0NBUVY7QUFFRCxNQUFNLENBQUMsTUFBTSxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUM7Ozs7Ozs7Ozs7OztDQVl0QixDQUFDLENBQUE7QUFFRixNQUFNLENBQUMsS0FBSyxVQUFVLE1BQU0sQ0FDeEIsT0FBTyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLEtBQUs7SUFFdEMsTUFBTSxLQUFLLEdBQU0sSUFBSSxLQUFLLEVBQUUsQ0FBQztJQUM3QixLQUFLLENBQUMsT0FBTyxHQUFJLE9BQU8sQ0FBQztJQUN6QixLQUFLLENBQUMsS0FBSyxHQUFNLEtBQUssQ0FBQztJQUN2QixLQUFLLENBQUMsUUFBUSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDO0lBQzNDLEtBQUssQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO0lBQzFCLEtBQUssQ0FBQyxLQUFLLEdBQU0sS0FBSyxDQUFDO0lBQ3ZCLEtBQUssQ0FBQyxLQUFLLEdBQU0sS0FBSyxDQUFDO0lBQ3ZCLEtBQUssQ0FBQyxHQUFHLEdBQVEsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUMxQyxNQUFNLENBQUMsTUFBTSxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUM7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztLQXFCdEIsRUFBRTtRQUNDLFFBQVEsRUFBRyxLQUFLLENBQUMsT0FBTztRQUN4QixNQUFNLEVBQUssS0FBSyxDQUFDLEtBQUs7UUFDdEIsU0FBUyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQztRQUNwQyxTQUFTLEVBQUUsS0FBSyxDQUFDLFFBQVE7UUFDekIsTUFBTSxFQUFLLEtBQUssQ0FBQyxLQUFLO1FBQ3RCLE1BQU0sRUFBSyxLQUFLLENBQUMsS0FBSztRQUN0QixHQUFHLEVBQVEsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUU7S0FDdEMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQztBQUFBLENBQUM7QUFFRjs7Ozs7O0dBTUc7QUFDSCxNQUFNLENBQUMsS0FBSyxVQUFVLE1BQU0sQ0FBQyxPQUFPLEVBQUUsS0FBSztJQUN2QyxJQUFJLENBQUM7UUFDRCxNQUFNLENBQUMsTUFBTSxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUM7Ozs7U0FJdEIsRUFBRTtZQUNDLFFBQVEsRUFBRSxPQUFPO1lBQ2pCLE1BQU0sRUFBSSxLQUFLO1NBQ2xCLENBQUMsQ0FBQztJQUNQLENBQUM7SUFBQyxPQUFPLEdBQUcsRUFBRSxDQUFDLENBQUEsQ0FBQztBQUNwQixDQUFDO0FBQUEsQ0FBQztBQUVGLE1BQU0sQ0FBQyxLQUFLLFVBQVUsU0FBUztJQUMzQixJQUFJLENBQUM7UUFDRCxNQUFNLENBQUMsTUFBTSxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUM7O1NBRXRCLENBQUMsQ0FBQztJQUNQLENBQUM7SUFBQyxPQUFPLEdBQUcsRUFBRSxDQUFDLENBQUEsQ0FBQztBQUNwQixDQUFDO0FBQUEsQ0FBQztBQUVGLE1BQU0sQ0FBQyxLQUFLLFVBQVUsS0FBSztJQUN2QixNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsTUFBTSxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQVE7OztLQUc1QyxDQUFDLENBQUM7SUFFSCxLQUFLLElBQUksS0FBSyxJQUFJLE1BQU0sRUFBRSxDQUFDO1FBQ3ZCLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxLQUFLLENBQUMsUUFBUSxJQUFJLEtBQUssQ0FBQyxRQUFRLElBQUksS0FBSyxDQUFDLEtBQUssSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxPQUFPLEVBQUUsR0FBRyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUMsR0FBRyxJQUFJLFVBQVUsQ0FBQyxDQUFBO0lBQ3pKLENBQUM7QUFDTCxDQUFDO0FBQUEsQ0FBQztBQUVGLE1BQU0sQ0FBQyxLQUFLLFVBQVUsU0FBUyxDQUFDLE9BQU8sRUFBRSxLQUFLO0lBQzFDLElBQUksR0FBRyxHQUFHLEVBQUUsQ0FBQztJQUViLE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxNQUFNLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBUTs7Ozs7S0FLNUMsRUFBRTtRQUNDLFFBQVEsRUFBRSxPQUFPO1FBQ2pCLE1BQU0sRUFBSSxLQUFLO0tBQ2xCLENBQUMsQ0FBQztJQUVILEtBQUssSUFBSSxLQUFLLElBQUksTUFBTSxFQUFFLENBQUM7UUFDdkIsSUFBSSxLQUFLLENBQUMsT0FBTyxLQUFLLE9BQU8sSUFBSSxLQUFLLENBQUMsS0FBSyxLQUFLLEtBQUssRUFBRSxDQUFDO1lBQ3JELEdBQUcsSUFBSSxHQUFHLEtBQUssQ0FBQyxRQUFRLElBQUksS0FBSyxDQUFDLFFBQVEsSUFBSSxLQUFLLENBQUMsS0FBSyxJQUFJLENBQUMsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLE9BQU8sRUFBRSxHQUFHLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxHQUFHLElBQUksWUFBWSxDQUFDO1FBQ3RKLENBQUM7SUFDTCxDQUFDO0lBQ0QsT0FBTyxHQUFHLENBQUM7QUFDZixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKlxuICogQ29weXJpZ2h0IDIwMTQtMjAyNCBEYXZpZCBIZXJyb25cbiAqXG4gKiBUaGlzIGZpbGUgaXMgcGFydCBvZiBBa2FzaGFDTVMgKGh0dHA6Ly9ha2FzaGFjbXMuY29tLykuXG4gKlxuICogIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiAgeW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZSB3aXRoIHRoZSBMaWNlbnNlLlxuICogIFlvdSBtYXkgb2J0YWluIGEgY29weSBvZiB0aGUgTGljZW5zZSBhdFxuICpcbiAqICAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqICBkaXN0cmlidXRlZCB1bmRlciB0aGUgTGljZW5zZSBpcyBkaXN0cmlidXRlZCBvbiBhbiBcIkFTIElTXCIgQkFTSVMsXG4gKiAgV0lUSE9VVCBXQVJSQU5USUVTIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGVpdGhlciBleHByZXNzIG9yIGltcGxpZWQuXG4gKiAgU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCBwYXRoIGZyb20gJ25vZGU6cGF0aCc7XG5cbmltcG9ydCB7IHNxZGIgfSBmcm9tICcuL3NxZGIuanMnO1xuXG5jbGFzcyBUcmFjZSB7XG4gICAgYmFzZWRpcjogc3RyaW5nO1xuICAgIGZwYXRoOiBzdHJpbmc7XG4gICAgZnVsbHBhdGg/OiBzdHJpbmc7XG4gICAgcmVuZGVyVG86IHN0cmluZztcbiAgICBzdGFnZTogc3RyaW5nO1xuICAgIHN0YXJ0OiBzdHJpbmc7XG4gICAgbm93OiBzdHJpbmc7XG59XG5cbmF3YWl0IChhd2FpdCBzcWRiKS5ydW4oYFxuQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgXCJUUkFDRVNcIiAoXG4gICAgYmFzZWRpciAgVEVYVCxcbiAgICBmcGF0aCAgICBURVhULFxuICAgIGZ1bGxwYXRoIFRFWHQsXG4gICAgcmVuZGVyVG8gVEVYVCxcbiAgICBzdGFnZSAgICBURVhUIERFRkFVTFQoZGF0ZXRpbWUoJ25vdycpIHx8ICdaJyksXG4gICAgc3RhcnQgICAgVEVYVCBERUZBVUxUKGRhdGV0aW1lKCdub3cnKSB8fCAnWicpLFxuICAgIG5vdyAgICAgIFRFWFQgREVGQVVMVChkYXRldGltZSgnbm93JykgfHwgJ1onKVxuKSBXSVRIT1VUIFJPV0lEO1xuQ1JFQVRFIElOREVYIFwidHJhY2VzX2Jhc2VkaXJcIiBPTiBcIlRSQUNFU1wiIChcImJhc2VkaXJcIik7XG5DUkVBVEUgSU5ERVggXCJ0cmFjZXNfZnBhdGhcIiAgIE9OIFwiVFJBQ0VTXCIgKFwiZnBhdGhcIik7XG5gKVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcmVwb3J0KFxuICAgIGJhc2VkaXIsIGZwYXRoLCByZW5kZXJUbywgc3RhZ2UsIHN0YXJ0XG4pIHtcbiAgICBjb25zdCB0cmFjZSAgICA9IG5ldyBUcmFjZSgpO1xuICAgIHRyYWNlLmJhc2VkaXIgID0gYmFzZWRpcjtcbiAgICB0cmFjZS5mcGF0aCAgICA9IGZwYXRoO1xuICAgIHRyYWNlLmZ1bGxwYXRoID0gcGF0aC5qb2luKGJhc2VkaXIsIGZwYXRoKTtcbiAgICB0cmFjZS5yZW5kZXJUbyA9IHJlbmRlclRvO1xuICAgIHRyYWNlLnN0YWdlICAgID0gc3RhZ2U7XG4gICAgdHJhY2Uuc3RhcnQgICAgPSBzdGFydDtcbiAgICB0cmFjZS5ub3cgICAgICA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTtcbiAgICBhd2FpdCAoYXdhaXQgc3FkYikucnVuKGBcbiAgICBJTlNFUlQgSU5UTyBcIlRSQUNFU1wiXG4gICAgICAgIChcbiAgICAgICAgICAgIGJhc2VkaXIsXG4gICAgICAgICAgICBmcGF0aCxcbiAgICAgICAgICAgIGZ1bGxwYXRoLFxuICAgICAgICAgICAgcmVuZGVyVG8sXG4gICAgICAgICAgICBzdGFnZSxcbiAgICAgICAgICAgIHN0YXJ0LFxuICAgICAgICAgICAgbm93XG4gICAgICAgIClcbiAgICAgICAgVkFMVUVTXG4gICAgICAgIChcbiAgICAgICAgICAgICRiYXNlZGlyLFxuICAgICAgICAgICAgJGZwYXRoLFxuICAgICAgICAgICAgJGZ1bGxwYXRoLFxuICAgICAgICAgICAgJHJlbmRlclRvLFxuICAgICAgICAgICAgJHN0YWdlLFxuICAgICAgICAgICAgJHN0YXJ0LFxuICAgICAgICAgICAgJG5vd1xuICAgICAgICApXG4gICAgYCwge1xuICAgICAgICAkYmFzZWRpcjogIHRyYWNlLmJhc2VkaXIsXG4gICAgICAgICRmcGF0aDogICAgdHJhY2UuZnBhdGgsXG4gICAgICAgICRmdWxscGF0aDogcGF0aC5qb2luKGJhc2VkaXIsIGZwYXRoKSxcbiAgICAgICAgJHJlbmRlclRvOiB0cmFjZS5yZW5kZXJUbyxcbiAgICAgICAgJHN0YWdlOiAgICB0cmFjZS5zdGFnZSxcbiAgICAgICAgJHN0YXJ0OiAgICB0cmFjZS5zdGFydCxcbiAgICAgICAgbm93OiAgICAgICBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcbiAgICB9KTtcbn07XG5cbi8qKlxuICogU3VwcG9ydCByZW1vdmluZyBpdGVtcyBmcm9tIHRoZSBzYXZlZCBkYXRhLiAgVGhpcyBpcyB1c2VmdWxcbiAqIHdoZW4gd2UncmUgcmVuZGVyaW5nIHRoZSBzYW1lIGZpbGUgbXVsdGlwbGUgdGltZXMuXG4gKlxuICogQHBhcmFtIHsqfSBiYXNlZGlyXG4gKiBAcGFyYW0geyp9IGZwYXRoXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiByZW1vdmUoYmFzZWRpciwgZnBhdGgpIHtcbiAgICB0cnkge1xuICAgICAgICBhd2FpdCAoYXdhaXQgc3FkYikucnVuKGBcbiAgICAgICAgICAgIERFTEVURSBGUk9NIFwiVFJBQ0VTXCJcbiAgICAgICAgICAgIFdIRVJFXG4gICAgICAgICAgICBiYXNlZGlyID0gJGJhc2VkaXIgQU5EIGZwYXRoID0gJGZwYXRoXG4gICAgICAgIGAsIHtcbiAgICAgICAgICAgICRiYXNlZGlyOiBiYXNlZGlyLFxuICAgICAgICAgICAgJGZwYXRoOiAgIGZwYXRoXG4gICAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycikge31cbn07XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiByZW1vdmVBbGwoKSB7XG4gICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgKGF3YWl0IHNxZGIpLnJ1bihgXG4gICAgICAgICAgICBERUxFVEUgRlJPTSBcIlRSQUNFU1wiXG4gICAgICAgIGApO1xuICAgIH0gY2F0Y2ggKGVycikge31cbn07XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBwcmludCgpIHtcbiAgICBjb25zdCB0cmFjZXMgPSBhd2FpdCAoYXdhaXQgc3FkYikuYWxsPFRyYWNlPihgXG4gICAgICAgIFNFTEVDVCAqIEZST00gXCJUUkFDRVNcIlxuICAgICAgICBPUkRFUiBCWSBmdWxscGF0aFxuICAgIGApO1xuXG4gICAgZm9yIChsZXQgdHJhY2Ugb2YgdHJhY2VzKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGAke3RyYWNlLmZ1bGxwYXRofSAke3RyYWNlLnJlbmRlclRvfSAke3RyYWNlLnN0YWdlfSAkeyhuZXcgRGF0ZSh0cmFjZS5ub3cpLnZhbHVlT2YoKSAtIG5ldyBEYXRlKHRyYWNlLnN0YXJ0KS52YWx1ZU9mKCkpIC8gMTAwMH0gc2Vjb25kc2ApXG4gICAgfVxufTtcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGRhdGE0ZmlsZShiYXNlZGlyLCBmcGF0aCkge1xuICAgIGxldCByZXQgPSBcIlwiO1xuXG4gICAgY29uc3QgdHJhY2VzID0gYXdhaXQgKGF3YWl0IHNxZGIpLmFsbDxUcmFjZT4oYFxuICAgICAgICBTRUxFQ1QgKiBGUk9NIFwiVFJBQ0VTXCJcbiAgICAgICAgV0hFUkUgXG4gICAgICAgICAgICBiYXNlZGlyID0gJGJhc2VkaXIgQU5EIGZwYXRoID0gJGZwYXRoXG4gICAgICAgIE9SREVSIEJZIGZ1bGxwYXRoXG4gICAgYCwge1xuICAgICAgICAkYmFzZWRpcjogYmFzZWRpcixcbiAgICAgICAgJGZwYXRoOiAgIGZwYXRoXG4gICAgfSk7XG5cbiAgICBmb3IgKGxldCB0cmFjZSBvZiB0cmFjZXMpIHtcbiAgICAgICAgaWYgKHRyYWNlLmJhc2VkaXIgPT09IGJhc2VkaXIgJiYgdHJhY2UuZnBhdGggPT09IGZwYXRoKSB7XG4gICAgICAgICAgICByZXQgKz0gYCR7dHJhY2UuZnVsbHBhdGh9ICR7dHJhY2UucmVuZGVyVG99ICR7dHJhY2Uuc3RhZ2V9ICR7KG5ldyBEYXRlKHRyYWNlLm5vdykudmFsdWVPZigpIC0gbmV3IERhdGUodHJhY2Uuc3RhcnQpLnZhbHVlT2YoKSkgLyAxMDAwfSBzZWNvbmRzXFxuYDtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmV0O1xufVxuIl19