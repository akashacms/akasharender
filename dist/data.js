/**
 *
 * Copyright 2014-2024 David Herron
 *
 * This file is part of AkashaCMS (http://akashacms.com/).
 *
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 */
import path from 'node:path';
import { promises as fsp } from 'node:fs';
import { sqdb } from './sqdb.js';
const sql_create_table = await fsp.readFile(path.join(import.meta.dirname, 'sql', 'data-create-table.sql'), 'utf-8');
const sql_add_report = await fsp.readFile(path.join(import.meta.dirname, 'sql', 'data-add-report.sql'), 'utf-8');
const sql_delete_traces = await fsp.readFile(path.join(import.meta.dirname, 'sql', 'data-delete-traces.sql'), 'utf-8');
const sql_delete_all_traces = await fsp.readFile(path.join(import.meta.dirname, 'sql', 'data-delete-all-traces.sql'), 'utf-8');
const sql_get_all_traces = await fsp.readFile(path.join(import.meta.dirname, 'sql', 'data-get-all-traces.sql'), 'utf-8');
const sql_get_for_file = await fsp.readFile(path.join(import.meta.dirname, 'sql', 'data-for-file.sql'), 'utf-8');
class Trace {
}
export async function init() {
    await (await sqdb).run(sql_create_table);
}
export async function report(basedir, fpath, renderTo, stage, start) {
    const trace = new Trace();
    trace.basedir = basedir;
    trace.fpath = fpath;
    trace.fullpath = path.join(basedir, fpath);
    trace.renderTo = renderTo;
    trace.stage = stage;
    trace.start = start.toISOString();
    trace.now = new Date().toISOString();
    // console.log(`data report`, trace);
    await (await sqdb).run(await sql_add_report, {
        $basedir: trace.basedir,
        $fpath: trace.fpath,
        $fullpath: trace.fullpath,
        $renderTo: trace.renderTo,
        $stage: trace.stage,
        $start: trace.start,
        $now: trace.now
    });
}
;
/**
 * Support removing items from the saved data.  This is useful
 * when we're rendering the same file multiple times.
 *
 * @param {*} basedir
 * @param {*} fpath
 */
export async function remove(basedir, fpath) {
    try {
        await (await sqdb).run(await sql_delete_traces, {
            $basedir: basedir,
            $fpath: fpath
        });
    }
    catch (err) { }
}
;
export async function removeAll() {
    try {
        await (await sqdb).run(await sql_delete_all_traces);
    }
    catch (err) { }
}
;
export async function print() {
    const traces = await (await sqdb).all(await sql_get_all_traces);
    for (let trace of traces) {
        console.log(`${trace.fullpath} ${trace.renderTo} ${trace.stage} ${(new Date(trace.now).valueOf() - new Date(trace.start).valueOf()) / 1000} seconds`);
    }
}
;
export async function data4file(basedir, fpath) {
    // console.log(`data4file ${basedir} ${fpath}`);
    let ret = "";
    const traces = await (await sqdb).all(await sql_get_for_file, {
        $basedir: basedir,
        $fpath: fpath
    });
    for (let trace of traces) {
        if (trace.basedir === basedir && trace.fpath === fpath) {
            ret += `${trace.fullpath} ${trace.renderTo} ${trace.stage} ${(new Date(trace.now).valueOf() - new Date(trace.start).valueOf()) / 1000} seconds\n`;
        }
    }
    return ret;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL2xpYi9kYXRhLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7Ozs7Ozs7OztHQWlCRztBQUVILE9BQU8sSUFBSSxNQUFNLFdBQVcsQ0FBQztBQUM3QixPQUFPLEVBQUUsUUFBUSxJQUFJLEdBQUcsRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUUxQyxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBR2pDLE1BQU0sZ0JBQWdCLEdBQUcsTUFBTSxHQUFHLENBQUMsUUFBUSxDQUN2QyxJQUFJLENBQUMsSUFBSSxDQUNMLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLEtBQUssRUFBRSx1QkFBdUIsQ0FDdEQsRUFDRCxPQUFPLENBQ1YsQ0FBQztBQUVGLE1BQU0sY0FBYyxHQUFHLE1BQU0sR0FBRyxDQUFDLFFBQVEsQ0FDckMsSUFBSSxDQUFDLElBQUksQ0FDTCxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxLQUFLLEVBQUUscUJBQXFCLENBQ3BELEVBQ0QsT0FBTyxDQUNWLENBQUM7QUFFRixNQUFNLGlCQUFpQixHQUFHLE1BQU0sR0FBRyxDQUFDLFFBQVEsQ0FDeEMsSUFBSSxDQUFDLElBQUksQ0FDTCxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxLQUFLLEVBQUUsd0JBQXdCLENBQ3ZELEVBQ0QsT0FBTyxDQUNWLENBQUM7QUFFRixNQUFNLHFCQUFxQixHQUFHLE1BQU0sR0FBRyxDQUFDLFFBQVEsQ0FDNUMsSUFBSSxDQUFDLElBQUksQ0FDTCxNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxLQUFLLEVBQUUsNEJBQTRCLENBQzNELEVBQ0QsT0FBTyxDQUNWLENBQUM7QUFFRixNQUFNLGtCQUFrQixHQUFHLE1BQU0sR0FBRyxDQUFDLFFBQVEsQ0FDekMsSUFBSSxDQUFDLElBQUksQ0FDTCxNQUFNLENBQUMsSUFBSSxDQUFDLE9B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QUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxPQUFPLEVBQUUsR0FBRyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUMsR0FBRyxJQUFJLFVBQVUsQ0FBQyxDQUFBO0lBQ3pKLENBQUM7QUFDTCxDQUFDO0FBQUEsQ0FBQztBQUVGLE1BQU0sQ0FBQyxLQUFLLFVBQVUsU0FBUyxDQUFDLE9BQU8sRUFBRSxLQUFLO0lBQzFDLGdEQUFnRDtJQUNoRCxJQUFJLEdBQUcsR0FBRyxFQUFFLENBQUM7SUFFYixNQUFNLE1BQU0sR0FDTixNQUFNLENBQUMsTUFBTSxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQVEsTUFBTSxnQkFBZ0IsRUFBRTtRQUN4RCxRQUFRLEVBQUUsT0FBTztRQUNqQixNQUFNLEVBQUksS0FBSztLQUNsQixDQUFDLENBQUM7SUFFSCxLQUFLLElBQUksS0FBSyxJQUFJLE1BQU0sRUFBRSxDQUFDO1FBQ3ZCLElBQUksS0FBSyxDQUFDLE9BQU8sS0FBSyxPQUFPLElBQUksS0FBSyxDQUFDLEtBQUssS0FBSyxLQUFLLEVBQUUsQ0FBQztZQUNyRCxHQUFHLElBQUksR0FBRyxLQUFLLENBQUMsUUFBUSxJQUFJLEtBQUssQ0FBQyxRQUFRLElBQUksS0FBSyxDQUFDLEtBQUssSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxPQUFPLEVBQUUsR0FBRyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUMsR0FBRyxJQUFJLFlBQVksQ0FBQztRQUN0SixDQUFDO0lBQ0wsQ0FBQztJQUNELE9BQU8sR0FBRyxDQUFDO0FBQ2YsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICpcbiAqIENvcHlyaWdodCAyMDE0LTIwMjQgRGF2aWQgSGVycm9uXG4gKlxuICogVGhpcyBmaWxlIGlzIHBhcnQgb2YgQWthc2hhQ01TIChodHRwOi8vYWthc2hhY21zLmNvbS8pLlxuICpcbiAqICBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpO1xuICogIHlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2Ugd2l0aCB0aGUgTGljZW5zZS5cbiAqICBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqICBVbmxlc3MgcmVxdWlyZWQgYnkgYXBwbGljYWJsZSBsYXcgb3IgYWdyZWVkIHRvIGluIHdyaXRpbmcsIHNvZnR3YXJlXG4gKiAgZGlzdHJpYnV0ZWQgdW5kZXIgdGhlIExpY2Vuc2UgaXMgZGlzdHJpYnV0ZWQgb24gYW4gXCJBUyBJU1wiIEJBU0lTLFxuICogIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9ucyBhbmRcbiAqICBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgcGF0aCBmcm9tICdub2RlOnBhdGgnO1xuaW1wb3J0IHsgcHJvbWlzZXMgYXMgZnNwIH0gZnJvbSAnbm9kZTpmcyc7XG5cbmltcG9ydCB7IHNxZGIgfSBmcm9tICcuL3NxZGIuanMnO1xuaW1wb3J0IHsgQXN5bmNEYXRhYmFzZSB9IGZyb20gJ3Byb21pc2VkLXNxbGl0ZTMnO1xuXG5jb25zdCBzcWxfY3JlYXRlX3RhYmxlID0gYXdhaXQgZnNwLnJlYWRGaWxlKFxuICAgIHBhdGguam9pbihcbiAgICAgICAgaW1wb3J0Lm1ldGEuZGlybmFtZSwgJ3NxbCcsICdkYXRhLWNyZWF0ZS10YWJsZS5zcWwnXG4gICAgKSxcbiAgICAndXRmLTgnXG4pO1xuXG5jb25zdCBzcWxfYWRkX3JlcG9ydCA9IGF3YWl0IGZzcC5yZWFkRmlsZShcbiAgICBwYXRoLmpvaW4oXG4gICAgICAgIGltcG9ydC5tZXRhLmRpcm5hbWUsICdzcWwnLCAnZGF0YS1hZGQtcmVwb3J0LnNxbCdcbiAgICApLFxuICAgICd1dGYtOCdcbik7XG5cbmNvbnN0IHNxbF9kZWxldGVfdHJhY2VzID0gYXdhaXQgZnNwLnJlYWRGaWxlKFxuICAgIHBhdGguam9pbihcbiAgICAgICAgaW1wb3J0Lm1ldGEuZGlybmFtZSwgJ3NxbCcsICdkYXRhLWRlbGV0ZS10cmFjZXMuc3FsJ1xuICAgICksXG4gICAgJ3V0Zi04J1xuKTtcblxuY29uc3Qgc3FsX2RlbGV0ZV9hbGxfdHJhY2VzID0gYXdhaXQgZnNwLnJlYWRGaWxlKFxuICAgIHBhdGguam9pbihcbiAgICAgICAgaW1wb3J0Lm1ldGEuZGlybmFtZSwgJ3NxbCcsICdkYXRhLWRlbGV0ZS1hbGwtdHJhY2VzLnNxbCdcbiAgICApLFxuICAgICd1dGYtOCdcbik7XG5cbmNvbnN0IHNxbF9nZXRfYWxsX3RyYWNlcyA9IGF3YWl0IGZzcC5yZWFkRmlsZShcbiAgICBwYXRoLmpvaW4oXG4gICAgICAgIGltcG9ydC5tZXRhLmRpcm5hbWUsICdzcWwnLCAnZGF0YS1nZXQtYWxsLXRyYWNlcy5zcWwnXG4gICAgKSxcbiAgICAndXRmLTgnXG4pO1xuXG5jb25zdCBzcWxfZ2V0X2Zvcl9maWxlID0gYXdhaXQgZnNwLnJlYWRGaWxlKFxuICAgIHBhdGguam9pbihcbiAgICAgICAgaW1wb3J0Lm1ldGEuZGlybmFtZSwgJ3NxbCcsICdkYXRhLWZvci1maWxlLnNxbCdcbiAgICApLFxuICAgICd1dGYtOCdcbik7XG5cbmNsYXNzIFRyYWNlIHtcbiAgICBiYXNlZGlyOiBzdHJpbmc7XG4gICAgZnBhdGg6IHN0cmluZztcbiAgICBmdWxscGF0aD86IHN0cmluZztcbiAgICByZW5kZXJUbzogc3RyaW5nO1xuICAgIHN0YWdlOiBzdHJpbmc7XG4gICAgc3RhcnQ6IHN0cmluZztcbiAgICBub3c6IHN0cmluZztcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGluaXQoKSB7XG4gICAgYXdhaXQgKGF3YWl0IHNxZGIpLnJ1bihzcWxfY3JlYXRlX3RhYmxlKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHJlcG9ydChcbiAgICBiYXNlZGlyLCBmcGF0aCwgcmVuZGVyVG8sIHN0YWdlLCBzdGFydDogRGF0ZVxuKSB7XG4gICAgY29uc3QgdHJhY2UgICAgPSBuZXcgVHJhY2UoKTtcbiAgICB0cmFjZS5iYXNlZGlyICA9IGJhc2VkaXI7XG4gICAgdHJhY2UuZnBhdGggICAgPSBmcGF0aDtcbiAgICB0cmFjZS5mdWxscGF0aCA9IHBhdGguam9pbihiYXNlZGlyLCBmcGF0aCk7XG4gICAgdHJhY2UucmVuZGVyVG8gPSByZW5kZXJUbztcbiAgICB0cmFjZS5zdGFnZSAgICA9IHN0YWdlO1xuICAgIHRyYWNlLnN0YXJ0ICAgID0gc3RhcnQudG9JU09TdHJpbmcoKTtcbiAgICB0cmFjZS5ub3cgICAgICA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTtcbiAgICAvLyBjb25zb2xlLmxvZyhgZGF0YSByZXBvcnRgLCB0cmFjZSk7XG4gICAgYXdhaXQgKGF3YWl0IHNxZGIpLnJ1bihhd2FpdCBzcWxfYWRkX3JlcG9ydCwge1xuICAgICAgICAkYmFzZWRpcjogIHRyYWNlLmJhc2VkaXIsXG4gICAgICAgICRmcGF0aDogICAgdHJhY2UuZnBhdGgsXG4gICAgICAgICRmdWxscGF0aDogdHJhY2UuZnVsbHBhdGgsXG4gICAgICAgICRyZW5kZXJUbzogdHJhY2UucmVuZGVyVG8sXG4gICAgICAgICRzdGFnZTogICAgdHJhY2Uuc3RhZ2UsXG4gICAgICAgICRzdGFydDogICAgdHJhY2Uuc3RhcnQsXG4gICAgICAgICRub3c6ICAgICAgIHRyYWNlLm5vd1xuICAgIH0pO1xufTtcblxuLyoqXG4gKiBTdXBwb3J0IHJlbW92aW5nIGl0ZW1zIGZyb20gdGhlIHNhdmVkIGRhdGEuICBUaGlzIGlzIHVzZWZ1bFxuICogd2hlbiB3ZSdyZSByZW5kZXJpbmcgdGhlIHNhbWUgZmlsZSBtdWx0aXBsZSB0aW1lcy5cbiAqXG4gKiBAcGFyYW0geyp9IGJhc2VkaXJcbiAqIEBwYXJhbSB7Kn0gZnBhdGhcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHJlbW92ZShiYXNlZGlyLCBmcGF0aCkge1xuICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IChhd2FpdCBzcWRiKS5ydW4oYXdhaXQgc3FsX2RlbGV0ZV90cmFjZXMsIHtcbiAgICAgICAgICAgICRiYXNlZGlyOiBiYXNlZGlyLFxuICAgICAgICAgICAgJGZwYXRoOiAgIGZwYXRoXG4gICAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycikge31cbn07XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiByZW1vdmVBbGwoKSB7XG4gICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgKGF3YWl0IHNxZGIpLnJ1bihhd2FpdCBzcWxfZGVsZXRlX2FsbF90cmFjZXMpO1xuICAgIH0gY2F0Y2ggKGVycikge31cbn07XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBwcmludCgpIHtcbiAgICBjb25zdCB0cmFjZXNcbiAgICAgICAgPSBhd2FpdCAoYXdhaXQgc3FkYikuYWxsPFRyYWNlPihhd2FpdCBzcWxfZ2V0X2FsbF90cmFjZXMpO1xuXG4gICAgZm9yIChsZXQgdHJhY2Ugb2YgdHJhY2VzKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGAke3RyYWNlLmZ1bGxwYXRofSAke3RyYWNlLnJlbmRlclRvfSAke3RyYWNlLnN0YWdlfSAkeyhuZXcgRGF0ZSh0cmFjZS5ub3cpLnZhbHVlT2YoKSAtIG5ldyBEYXRlKHRyYWNlLnN0YXJ0KS52YWx1ZU9mKCkpIC8gMTAwMH0gc2Vjb25kc2ApXG4gICAgfVxufTtcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGRhdGE0ZmlsZShiYXNlZGlyLCBmcGF0aCkge1xuICAgIC8vIGNvbnNvbGUubG9nKGBkYXRhNGZpbGUgJHtiYXNlZGlyfSAke2ZwYXRofWApO1xuICAgIGxldCByZXQgPSBcIlwiO1xuXG4gICAgY29uc3QgdHJhY2VzXG4gICAgICAgID0gYXdhaXQgKGF3YWl0IHNxZGIpLmFsbDxUcmFjZT4oYXdhaXQgc3FsX2dldF9mb3JfZmlsZSwge1xuICAgICAgICAkYmFzZWRpcjogYmFzZWRpcixcbiAgICAgICAgJGZwYXRoOiAgIGZwYXRoXG4gICAgfSk7XG5cbiAgICBmb3IgKGxldCB0cmFjZSBvZiB0cmFjZXMpIHtcbiAgICAgICAgaWYgKHRyYWNlLmJhc2VkaXIgPT09IGJhc2VkaXIgJiYgdHJhY2UuZnBhdGggPT09IGZwYXRoKSB7XG4gICAgICAgICAgICByZXQgKz0gYCR7dHJhY2UuZnVsbHBhdGh9ICR7dHJhY2UucmVuZGVyVG99ICR7dHJhY2Uuc3RhZ2V9ICR7KG5ldyBEYXRlKHRyYWNlLm5vdykudmFsdWVPZigpIC0gbmV3IERhdGUodHJhY2Uuc3RhcnQpLnZhbHVlT2YoKSkgLyAxMDAwfSBzZWNvbmRzXFxuYDtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmV0O1xufVxuIl19